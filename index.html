<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>検索付きマップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .search-container {
      position: absolute;
      top: 10px;
      left: 10px;  /* ← 左上に配置 */
      z-index: 1000;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 8px;
    }

    .search-container input {
      padding: 6px;
      font-size: 14px;
      width: 180px;
    }

    .gps-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-container">
    <input type="text" id="searchBox" placeholder="地名や施設名を検索" />
  </div>
  <div class="gps-button" onclick="toggleTracking()">📍 GPS</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([36.2917, 139.7351], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // ---- レイヤ定義（サンプル名） ----
    const bunsuikoLayer = L.geoJSON(null, {
      onEachFeature: onEachFeature
    });

    const kaisuiroLayer = L.geoJSON(null, {
      onEachFeature: onEachFeature
    });

    const oazaLayer = L.geoJSON(null, {
      style: { color: "#ff01e6", weight: 2 },
      onEachFeature: onEachFeature
    });

    const chibanLayer = L.geoJSON(null, {
      style: {
        color: "blue",
        fillColor: "white",
        fillOpacity: 0.5,
        weight: 1
      }
    });

    const yosuikiLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) =>
        L.circleMarker(latlng, {
          radius: 6,
          fillColor: "yellowgreen",
          color: "#555",
          weight: 1,
          fillOpacity: 0.8
        }),
      onEachFeature: onEachFeature
    });

    // 表示順（最下層が先）
    bunsuikoLayer.addTo(map);
    yosuikiLayer.addTo(map);
    kaisuiroLayer.addTo(map);
    oazaLayer.addTo(map);
    chibanLayer.addTo(map);

    L.control.layers(null, {
      "分水工・頭首工": bunsuikoLayer,
      "揚水機場": yosuikiLayer,
      "開水路": kaisuiroLayer,
      "大字境界": oazaLayer,
      "地番確認": chibanLayer
    }).addTo(map);

    // ---- GeoJSON読み込み（ファイル名に合わせて変更） ----
    fetch('bunsuiko_toshuko.geojson').then(res => res.json()).then(data => {
      bunsuikoLayer.addData(data);
    });

    fetch('yosuiki.geojson').then(res => res.json()).then(data => {
      yosuikiLayer.addData(data);
    });

    fetch('kaisuiro.geojson').then(res => res.json()).then(data => {
      kaisuiroLayer.addData(data);
    });

    fetch('oaza.geojson').then(res => res.json()).then(data => {
      oazaLayer.addData(data);
    });

    fetch('chiban.geojson').then(res => res.json()).then(data => {
      chibanLayer.addData(data);
    });

    function onEachFeature(feature, layer) {
      let popup = '';
      for (let key in feature.properties) {
        popup += `<strong>${key}</strong>: ${feature.properties[key]}<br>`;
      }
      layer.bindPopup(popup);
    }

    // ---- 検索機能（内部一致） ----
    document.getElementById('searchBox').addEventListener('input', function () {
      const keyword = this.value.toLowerCase();

      [bunsuikoLayer, yosuikiLayer, kaisuiroLayer].forEach(layer => {
        layer.eachLayer(l => {
          const props = l.feature.properties;
          const found = Object.values(props).some(val =>
            String(val).toLowerCase().includes(keyword)
          );
          if (found) {
            l.openPopup();
            map.fitBounds(l.getBounds ? l.getBounds() : L.latLngBounds(l.getLatLng()));
          }
        });
      });
    });

    // ---- GPS機能 ----
    let gpsMarker = null;
    let gpsCircle = null;
    let watchId = null;
    let isTracking = false;

    function toggleTracking() {
      if (isTracking) {
        navigator.geolocation.clearWatch(watchId);
        if (gpsMarker) map.removeLayer(gpsMarker);
        if (gpsCircle) map.removeLayer(gpsCircle);
        isTracking = false;
        alert("GPS追跡を停止しました");
      } else {
        if (!navigator.geolocation) {
          alert("この端末ではGPSが使えません");
          return;
        }

        watchId = navigator.geolocation.watchPosition(
          pos => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            if (!gpsMarker) {
              gpsMarker = L.marker(latlng).addTo(map);
              gpsCircle = L.circle(latlng, {
                radius: pos.coords.accuracy,
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.2
              }).addTo(map);
            } else {
              gpsMarker.setLatLng(latlng);
              gpsCircle.setLatLng(latlng).setRadius(pos.coords.accuracy);
            }
            map.setView(latlng, 16);
          },
          err => alert("位置取得に失敗：" + err.message),
          { enableHighAccuracy: true }
        );
        isTracking = true;
        alert("GPS追跡を開始しました");
      }
    }
  </script>
</body>
</html>