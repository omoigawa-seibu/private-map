<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet 地図</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .search-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .leaflet-control-zoom {
      left: 10px !important;
      right: auto !important;
    }
  </style>
</head>
<body>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="検索..." />
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([36.2917, 139.7351], 15);
    map.zoomControl.setPosition('bottomleft');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const overlayMaps = {};
    const searchableLayers = [];

    function createPopup(feature) {
      let content = '';
      for (let key in feature.properties) {
        content += `<strong>${key}</strong>: ${feature.properties[key]}<br>`;
      }
      return content;
    }

    function loadLayer(file, name, options = {}) {
      fetch(file)
        .then(res => res.json())
        .then(data => {
          const layer = L.geoJSON(data, {
            style: options.style || undefined,
            pointToLayer: options.isPoint ? function (feature, latlng) {
              return L.circleMarker(latlng, {
                radius: 6,
                color: options.color || "#000",
                fillColor: options.fillColor || "#000",
                fillOpacity: options.fillOpacity || 0.8,
                weight: 1
              });
            } : undefined,
            onEachFeature: function (feature, layer) {
              const label = feature.properties[options.labelField] || feature.properties.name || '';
              if (label && options.labelField) {
                layer.bindTooltip(label, { permanent: true, direction: 'right' });
              }
              layer.on('click', function () {
                layer.bindPopup(createPopup(feature)).openPopup();
              });
              searchableLayers.push({ name: label, layer });
            }
          });
          layer.addTo(map);
          overlayMaps[name] = layer;
          layersControl.addOverlay(layer, name);
        });
    }

    // レイヤコントロールを後から使うため先に定義
    const layersControl = L.control.layers(null, null, { collapsed: false }).addTo(map);

    // レイヤを順番に読み込み（順序重要）
    loadLayer("chiban.geojson", "地番確認", {
      style: { color: "blue", fillColor: "white", fillOpacity: 0.5 }
    });

    loadLayer("oaza.geojson", "大字境界", {
      style: { color: "#ff01e6", weight: 2, fillOpacity: 0 }
    });

    fetch("kaisuiro.geojson")
      .then(res => res.json())
      .then(data => {
        const kaisuiroLayer = L.geoJSON(data, {
          style: function (feature) {
            const val = feature.properties.PP1_C02;
            let color = "#000";
            if (val === "005") color = "orange";
            else if (val === "006") color = "#01ffea";
            return { color: color };
          },
          onEachFeature: function (feature, layer) {
            const label = feature.properties.name || '';
            searchableLayers.push({ name: label, layer });
            layer.on('click', function () {
              layer.bindPopup(createPopup(feature)).openPopup();
            });
          }
        });
        kaisuiroLayer.addTo(map);
        overlayMaps["開水路"] = kaisuiroLayer;
        layersControl.addOverlay(kaisuiroLayer, "開水路");
      });

    loadLayer("bunsuiko_toshuko.geojson", "分水工・頭首工", {
      isPoint: true,
      labelField: "名称",
      color: "green",
      fillColor: "green",
      fillOpacity: 0.7
    });

    loadLayer("yosuiki.geojson", "揚水機場", {
      isPoint: true,
      labelField: "機場名",
      color: "lightgreen",
      fillColor: "lightgreen",
      fillOpacity: 0.8
    });

    // 🔍 検索機能（内部一致＆表示中レイヤのみ）
    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.trim().toLowerCase();
      searchableLayers.forEach(({ name, layer }) => {
        if (!name) return;
        const visible = map.hasLayer(layer);
        if (keyword === "") {
          if (!map.hasLayer(layer)) map.addLayer(layer);
        } else if (name.toLowerCase().includes(keyword) && visible) {
          map.addLayer(layer);
        } else if (visible) {
          map.removeLayer(layer);
        }
      });
    });
  </script>
</body>
</html>