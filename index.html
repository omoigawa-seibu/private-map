<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>マイマップ</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .search-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 4px;
      border-radius: 4px;
      box-shadow: 0 0 5px #999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-box">
    <input type="text" id="search" placeholder="検索語句を入力..." />
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    const map = L.map("map").setView([36.25, 139.2], 13);

    // タイル（背景地図）
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    // 地番確認
    const chibanLayer = L.geoJSON(null, {
      style: {
        color: "blue",
        fillColor: "white",
        fillOpacity: 0.5
      }
    }).addTo(map);

    // 大字境界
    const oazaLayer = L.geoJSON(null, {
      style: {
        color: "#ff01e6",
        fill: false
      }
    }).addTo(map);

    // 開水路
    const kaisuiroLayer = L.geoJSON(null, {
      style: {
        color: "orange",
        weight: 3
      }
    }).addTo(map);

    // 分水工・頭首工
    const bunsuikoLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) =>
        L.circleMarker(latlng, {
          radius: 6,
          color: "green",
          fillColor: "green",
          fillOpacity: 1
        }),
      onEachFeature: (feature, layer) => {
        const name = feature.properties["名称"] || "名称なし";
        layer.bindTooltip(name, { permanent: true, direction: "top" });
        layer.bindPopup(`<b>分水工・頭首工</b><br>${name}`);
      }
    }).addTo(map);

    // 揚水機場（ピン型マーカー）
    const yosuikiLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) =>
        L.marker(latlng, {
          icon: L.icon({
            iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -41]
          })
        }),
      onEachFeature: (feature, layer) => {
        const name = feature.properties["機場名"] || "名称なし";
        layer.bindTooltip(name, { permanent: true, direction: "top" });
        layer.bindPopup(`<b>揚水機場</b><br>${name}`);
      }
    }).addTo(map);

    // レイヤグループ
    const overlayMaps = {
      "地番確認": chibanLayer,
      "大字境界": oazaLayer,
      "開水路": kaisuiroLayer,
      "分水工・頭首工": bunsuikoLayer,
      "揚水機場": yosuikiLayer
    };

    L.control.layers(null, overlayMaps, { position: "topright" }).addTo(map);

    // 検索機能（内部一致）
    document.getElementById("search").addEventListener("input", function () {
      const keyword = this.value.trim();
      const layersToSearch = [
        { layer: yosuikiLayer, key: "機場名" },
        { layer: bunsuikoLayer, key: "名称" }
      ];

      layersToSearch.forEach(({ layer, key }) => {
        layer.eachLayer(featureLayer => {
          const val = featureLayer.feature?.properties?.[key] || "";
          if (
            keyword === "" ||
            (!map.hasLayer(layer)) ||
            !val.includes(keyword)
          ) {
            featureLayer.setStyle?.({ opacity: 0, fillOpacity: 0 });
            featureLayer.getElement?.().style.display = "none";
            featureLayer.remove();
          } else {
            featureLayer.setStyle?.({ opacity: 1, fillOpacity: 1 });
            featureLayer.getElement?.().style.display = "block";
            if (!map.hasLayer(layer)) map.addLayer(layer);
          }
        });
      });
    });

    // GPSボタン
    L.control
      .locate({
        position: "bottomright",
        strings: { title: "GPS" }
      })
      .addTo(map);

    // 拡大縮小ボタン位置
    map.zoomControl.setPosition("bottomleft");

    // GeoJSONファイル読み込み
    fetch("chiban.geojson").then(res => res.json()).then(data => chibanLayer.addData(data));
    fetch("oaza.geojson").then(res => res.json()).then(data => oazaLayer.addData(data));
    fetch("kaisuiro.geojson").then(res => res.json()).then(data => kaisuiroLayer.addData(data));
    fetch("bunsuiko_toshuko.geojson").then(res => res.json()).then(data => bunsuikoLayer.addData(data));
    fetch("yosuiki.geojson").then(res => res.json()).then(data => yosuikiLayer.addData(data));
  </script>

  <!-- Leaflet.Locate Plugin (GPS用) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
</body>
</html>